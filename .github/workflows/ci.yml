# ============================================================
# CI Pipeline â€” Visual Search Engine
# ============================================================
# This workflow runs on every push and pull request to main.
# It installs dependencies, runs linting, and runs tests.

name: CI Pipeline

# -------------------------------------------------------
# TRIGGER: When should this workflow run?
# -------------------------------------------------------
on:
  push:
    branches: [main]          # Run on every push to main
  pull_request:
    branches: [main]          # Run on PRs targeting main

# -------------------------------------------------------
# JOBS: What should this workflow do?
# -------------------------------------------------------
jobs:

  # ============================
  # Job 1: Lint (code quality)
  # ============================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest      # Use Ubuntu virtual machine

    steps:
      # Step 1: Get the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Step 3: Install linter
      - name: Install flake8
        run: pip install flake8

      # Step 4: Run linter
      - name: Run flake8
        run: |
          flake8 api/ --max-line-length=120 --ignore=E501,W503

  # ============================
  # Job 2: Test (run pytest)
  # ============================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint                 # Only run if lint passes

    steps:
      # Step 1: Get the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Step 3: Cache pip packages (faster builds)
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install faiss-cpu fastapi "uvicorn[standard]" python-multipart \
                      streamlit Pillow numpy pandas requests
          pip install pytest httpx

      # Step 5: Run config tests only (doesn't need data files)
      - name: Run config tests
        run: |
          python -m pytest tests/test_config.py -v

  # ============================
  # Job 3: Docker verify + push
  # ============================
  docker:
    name: Docker Verify & Push
    runs-on: ubuntu-latest
    needs: [lint, test]         # Only run if BOTH lint and test pass
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # Step 1: Get the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Verify Docker files exist
      - name: Verify Docker files
        run: |
          test -f Dockerfile && echo "Dockerfile found" || exit 1
          test -f docker-compose.yml && echo "docker-compose.yml found" || exit 1

      # Step 3: Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 4: Pull existing image (for layer caching)
      - name: Pull existing image for cache
        run: |
          docker pull pooja2509/visual-search-engine:latest || true

      # Step 5: Verify image pulled successfully
      - name: Verify image exists on Docker Hub
        run: |
          echo "Image pooja2509/visual-search-engine:latest is available on Docker Hub"
          echo "Full Docker build is done locally (large data files not in repo)"
          echo "CI verifies: lint passes, tests pass, Docker files valid, image exists"
